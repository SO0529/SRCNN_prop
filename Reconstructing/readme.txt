2016/3/25　大谷

SR/Training/で学習したデータを使って超解像をするためのフォルダ。
基本的にはReconstructing内のMATLABフォルダで完結する。

cdでReconstructing/matlabに入ってMATLAB起動
※重要　startup.mのパスを自分のcaffeディレクトリに変更すること

all_experiment.mを走らせたらすべての実験（2倍・3倍・4倍のparallel,rotary(2倍のみ),multi,multi_rotary,multi_flip,従来手法）ができる。
make_PSNR_curve*.mというファイルはそれぞれの実験を呼び出す関数。これらはall_experimentからではなく、個別でも普通に実行できる。
例えばmake_PSNR_curve_multi_x2()だったら、2倍のmultiの実験ができる。
その関数の中身には
run_multi_x2('Set5','CPU',4900000,5000000)
みたいな関数がある。
run_multi_x2の第一引数は'Set5'の評価用画像に対して実験を行うことを指す。
第二引数はCPUとGPUのどちらで実験をするか、
第三引数と第四引数は何万回CNNを更新したデータから何万回CNNを更新したデータまで実験するかを指す。
上の例ならば、Set5に対して、CPUで、4900000回学習したデータから、5000000回学習したデータまで実験をすることになる。
現状ではCNNは100000回学習するたびに保存しているため、上の例だと2種類（4900000回と5000000回）のCNNで実験することになる。

第一引数の種類は'Set5'と'Set14'と'original_images'の3種類で、Reconstructing/test_images/の中にある画像を参照している。
第三引数の最初の数字は100000からで、これは100000ごとに保存していることに起因する。
学習済CNNのデータは、SR/Training/のところから適宜参照している。


rum_multi_x2という関数の中身が超解像のメインプログラムとなっている。
最初のほうでCNNの場所とか、超解像した奴の保存先とかを決めている。
PSNRと時間は勝手に測ってtxt形式で保存するようになっている。

例えばrun_multi_x2('Set5','GPU',100000,5000000)を実行したら、
Reconstructing/prop/x2/553_multi/PSNR_553_multi_Set5_GPU
というディレクトリが勝手に作られ、その中に実験結果が保存される。
そのディレクトリの中に学習回数のフォルダが作られ、その中にその学習回数での実験結果が保存される。
例えば100000というフォルダの中では、超解像後の画像とpsnr_100000.txtとtime_100000.txtができる。
psnr_100000.txtの中身はabc順に評価用画像のPSNRと最後の行はそれらの平均値が記述される。
time_100000.txtの中身も同様。
ちなみに容量削減のため、超解像後の画像は100000回の時と5000000回の時しか保存されないようになっている。


残りの細々したファイルは、画像の配列を並び替えたり、画像の周りを削ったりするプログラム。


※caffeの注意事項
caffeは内部で画像を回転してから処理をしているため、並び替えがおかしくなる時があることに気をつける。
これは並び替えをするプログラムであるcomposition_*.mの中身を見たらわかると思う。

超解像時にGPUで処理をする場合、1枚1枚の超解像で0.1秒ぐらいのpauseを入れないと、パソコンが落ちるので気をつけること。
このプログラムはその対策はすでにしています。（pause(0.1);のところ）

メモリ不足になるのでcaffeのメモリ解放（caffe.reset_all()）はちゃんと実行すること。

caffeを使った最初の超解像はcaffeを読み込んだりするための時間がかかる。
そのため、5000000回のCNNだけを実験したい場合も、一度4900000回のCNNで超解像をしてから5000000回のCNNで実験をすること。
そうしなければ処理時間が狂います。


基本的にこのSRというフォルダを大元にして、コピーしながら使うのが楽だと思う。
あとは試行錯誤しながら頑張ってください。
